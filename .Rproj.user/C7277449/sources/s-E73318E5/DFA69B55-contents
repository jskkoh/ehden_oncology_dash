# Cancer survival dashboard app

library(tidyverse)
library(readxl)

# load ref df with English life table (ONS) and HRQoL estimates (HSE and MVH) by age and sex 
survExCprd_df = read_excel("./data/cancer_extrapolation_results_ALL.xlsx",sheet="extrapolation_all")
rateHazCprd_df = read_excel("./data/cancer_extrapolation_results_ALL.xlsx",sheet="hazardrate_all")
fitCprd_df = read_excel("./data/cancer_extrapolation_results_ALL.xlsx",sheet="GOF_all")

kmCprd_df = read_excel("./data/cancer_KM_observed_results_ALL.xlsx",sheet="KM_observed_all")

# Load analysis functions
source("./R/cancerDashFunctions.R")

# Load loading page and help box code
source("./R/text_boxes.R")
source("./R/intro_page.R")

# intensity_cols = colorRampPalette(c("black","orange","red"))

# rename highchart donwload btn
lang <- getOption("highcharter.lang")
lang$contextButtonTitle <- "Download"
options(highcharter.lang = lang)

# consistent digits
fRound <- function(str, digits = 2, width = 2){
  formatC(str, digits = 2, width = 2, format = "f")
}

shinyServer(function(input, output,session) {
  
  
  
    # REACTIVE DATA -----------
    reactiveData = reactiveValues()
    
    observe({
      
      if(input$dataset == "cprd"){
        survEx_df = survExCprd_df
        rateHaz_df = rateHazCprd_df
        fit_df = fitCprd_df
        km_df = kmCprd_df
      }
      
      reactiveData$tableSurvPlot = survPlotTable(
        survEx_df,
        input$cancerType,
        input$age,
        input$sex,
        input$extrapMeth
      )
      
      reactiveData$tableSurvPlotKM = survPlotTableKM(
        km_df,
        input$cancerType,
        input$age,
        input$sex
      )
      
      
    })
    
    
    
    
    # HIGH CHARTS ---------
    output$survivalPlot = renderHighchart({
      highchartSurv()
    })
    
    highchartSurv <- reactive({
      hchart(reactiveData$tableSurvPlot,"line",
             hcaes(
               x = time,
               y = est,
               group = Method
             )) %>%
        hc_tooltip(
          valueDecimals = 3
        ) %>%
        hc_boost(enabled = FALSE) %>%
        hc_yAxis(
          title = list(text = "Survival probability"),
          max=1,min=0
        ) %>%
        hc_xAxis(
          title = list(text = "Time")
        ) %>%
        hc_title(
          text = "Survival probability"
        ) %>%
        hc_exporting(
          enabled = TRUE,
          formAttributes = list(
            target = "_blank"
          ),
          chartOptions = list(
            chart = list(
              backgroundColor = "white"
            )
          ),
          buttons = list(
            contextButton = list(
              symbol = "download",
              verticalAlign = "bottom",
              horizontalAlign = "left",
              #titleKey = "oinf",
              #          menuItems = NULL,
              onclick = JS("function () {
                     this.exportChart();
                 }")
            )
          )
        )
    })
    
})